name: Daily Fact Generator

on:
  schedule:
    - cron: "0 6 * * *" # Exécution tous les jours à Paris : 8h00 en été et 7h00 en hiver
  workflow_dispatch: # Permet de lancer manuellement l'action via l'interface GitHub

jobs:
  generate-fact:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "22" # à updater le cas échéant

      - name: Install dependencies
        run: |
          npm install

      - name: Check MongoDB connection
        run: |
            node -e "
              const mongoose = require('mongoose');
              mongoose.connect(process.env.MONGODB_URI, { 
                connectTimeoutMS: 4000,
                serverSelectionTimeoutMS: 5000 
              })
              .then(() => {
                console.log('Database connected');
              })
              .catch(err => {
                console.error('Error connecting to MongoDB:', err);
                process.exit(1); 
              });
            "
        env:
            MONGODB_URI: ${{ secrets.MONGODB_URI }}  # Assure-toi que le secret MONGODB_URI est configuré dans GitHub Secrets
  

      - name: Run the daily fact generator
        env:
          UTS_MISTRAL_API_KEY: ${{ secrets.UTS_MISTRAL_API_KEY }} # Utilise les secrets pour tes clés API
          FACT_GENERATION_PROMPT: ${{ secrets.FACT_GENERATION_PROMPT }}
          MISTRAL_AGENT_FACTGENERATOR_ID: ${{ secrets.MISTRAL_AGENT_FACTGENERATOR_ID }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          node -e "require('./controllers/facts.js').dailyFactGenerator();"
